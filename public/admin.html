<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin LFAF Tech - Radio Relax</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root { --primary: #e91e63; --bg: #f4f4f9; --text: #333; --green: #4CAF50; --blue: #2196F3; --red: #f44336; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        
        /* --- Estilos Generales de UI --- */
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: 600; padding: 10px 15px; border-radius: 6px; font-size: 0.95rem; transition: all 0.2s; }
        button:hover { opacity: 0.85; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        input[type="text"], input[type="search"] { padding: 10px; border-radius: 6px; border: 1px solid #ddd; font-size: 1rem; width: 100%; box-sizing: border-box; }
        .btn-green { background: var(--green); }
        .btn-blue { background: var(--blue); }
        .btn-red { background: var(--red); }
        .btn-grey { background: #6c757d; }
        .btn-small { padding: 5px 10px; font-size: 0.85rem; }

        /* --- Pesta√±as de Navegaci√≥n --- */
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 25px; }
        .tab-button { padding: 15px 25px; cursor: pointer; background: none; border: none; font-size: 1.1rem; font-weight: 600; color: #aaa; position: relative; }
        .tab-button.active { color: var(--primary); }
        .tab-button.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 3px; background: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- Pesta√±a 1: Carga Masiva --- */
        #drop-zone { border: 3px dashed #ccc; padding: 40px; text-align: center; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        #drop-zone.dragover { background: #ffeef4; border-color: var(--primary); transform: scale(1.02); }
        #upload-queue-container { margin-top: 20px; max-height: 300px; overflow-y: auto; background: #f9f9f9; border-radius: 8px; }
        .queue-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee; }
        .queue-item span { font-size: 0.9rem; }
        .queue-status { font-weight: 700; font-size: 0.9rem; }
        .status-pending { color: #aaa; }
        .status-uploading { color: var(--blue); }
        .status-done { color: var(--green); }
        .status-error { color: var(--red); }

        /* --- Pesta√±a 2: Gestor de Playlist --- */
        .playlist-controls { display: grid; grid-template-columns: 1fr auto; gap: 15px; margin-bottom: 20px; }
        .playlist-item { display: flex; align-items: center; padding: 12px; background: #f8f9fa; margin-bottom: 8px; border-radius: 6px; }
        .handle { cursor: move; padding: 0 10px; font-size: 1.5rem; color: #999; }
        .item-checkbox { margin-right: 10px; }
        .info { flex-grow: 1; }
        .meta { font-size: 0.85rem; color: #666; }
        .actions { display: flex; gap: 8px; }
        #pagination { margin-top: 20px; display: flex; justify-content: center; align-items: center; gap: 10px; }

        /* --- Pesta√±a 3: Publicaci√≥n --- */
        .publish-bar { background: #333; color: white; padding: 20px 25px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        #publish-btn { font-size: 1.2rem; padding: 15px 25px; }
        #txt-viewer { background: #2d2d2d; color: #f1f1f1; border-radius: 8px; padding: 15px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; margin-top: 20px; display: none; }
        #publish-log { background: #f1f1f1; border-radius: 8px; padding: 15px; max-height: 200px; overflow-y: auto; font-size: 0.9rem; }

        #loading { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.85); display: none; justify-content: center; align-items: center; font-size: 2rem; z-index: 999; }
    </style>
</head>
<body>

    <div id="loading">‚è≥ Procesando...</div>

    <div class="container">
        <header style="text-align: center; margin-bottom: 20px;">
            <h1>üéõÔ∏è Panel de Control - Radio Relax</h1>
        </header>

        <nav class="tabs">
            <button class="tab-button active" onclick="showTab('tab-upload')">üì§ Subir M√∫sica</button>
            <button class="tab-button" onclick="showTab('tab-manage')">üìã Gestor de Playlist</button>
            <button class="tab-button" onclick="showTab('tab-publish')">üì° Publicaci√≥n</button>
        </nav>

        <div id="tab-upload" class="tab-content active">
            <div class="card">
                <h2>Carga Masiva (Uno por Uno)</h2>
                <div id="drop-zone">
                    <h3>Arrastra tus 300+ archivos MP3 aqu√≠</h3>
                    <p>o haz click para seleccionar</p>
                    <input type="file" id="fileInput" accept="audio/*" multiple style="display: none;">
                </div>
                <div id="upload-queue-container">
                    <div id="upload-queue"></div>
                </div>
            </div>
        </div>

        <div id="tab-manage" class="tab-content">
            <div class="card">
                <div class="playlist-controls">
                    <input type="search" id="searchInput" placeholder="Buscar canciones por t√≠tulo...">
                    <button id="deleteSelectedBtn" class="btn-red">üóëÔ∏è Borrar Seleccionados</button>
                </div>
                <div id="playlist-container">Cargando...</div>
                <div id="pagination"></div>
            </div>
        </div>

        <div id="tab-publish" class="tab-content">
            <div class="card">
                <div class="publish-bar">
                    <span>Publica tus cambios para que salgan al aire.</span>
                    <button id="publish-btn" class="btn-green">üöÄ PUBLICAR CAMBIOS EN VIVO</button>
                </div>
            </div>
            <div class="card">
                <h2>Ver "Borrador" del TXT</h2>
                <p>As√≠ es como se ver√° el `playlist.txt` que tu transmisor descargar√° cuando publiques.</p>
                <button id="viewTxtBtn" class="btn-blue">Ver TXT (Borrador)</button>
                <pre id="txt-viewer"></pre>
            </div>
             <div class="card">
                <h2>Historial de Publicaciones (Log)</h2>
                <div id="publish-log" style="font-family: monospace;"></div>
            </div>
        </div>
    </div>

    <script>
        // --- ============================================= ---
        // --- CONFIGURACI√ìN GLOBAL Y AUTENTICACI√ìN          ---
        // --- ============================================= ---
        const API_KEY = localStorage.getItem('admin_key') || prompt("üîë Ingresa tu CLAVE DE ADMINISTRADOR:");
        if (API_KEY) localStorage.setItem('admin_key', API_KEY);

        const API_BASE = '/api/relax'; 
        const loading = document.getElementById('loading');
        const authHeaders = { 'x-api-key': API_KEY };

        const uploadQueue = []; // Aqu√≠ viven los archivos "En espera"
        let isUploading = false; // Bloqueo para subir de a uno

        // --- ============================================= ---
        // --- L√ìGICA DE PESTA√ëAS                          ---
        // --- ============================================= ---
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
            
            // Cargar la playlist solo cuando se hace clic en la pesta√±a "Gestionar"
            if (tabId === 'tab-manage') {
                loadPlaylist(1); // Cargar p√°gina 1
            }
        }

        // --- ============================================= ---
        // --- PESTA√ëA 1: L√ìGICA DE CARGA MASIVA             ---
        // --- ============================================= ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');
        const queueContainer = document.getElementById('upload-queue');

        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
        dropZone.ondragleave = () => dropZone.classList.remove('dragover');
        fileInput.onchange = () => handleFiles(fileInput.files);
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        };

        function handleFiles(files) {
            for (const file of files) {
                if (file.type.startsWith('audio/')) {
                    const queueId = `q-${Date.now()}-${Math.random()}`;
                    uploadQueue.push({ file: file, id: queueId }); // A√±adir a la cola
                    
                    // A√±adir a la UI
                    const itemEl = document.createElement('div');
                    itemEl.className = 'queue-item';
                    itemEl.id = queueId;
                    itemEl.innerHTML = `
                        <span>${file.name}</span>
                        <span class="queue-status status-pending">En espera...</span>
                    `;
                    queueContainer.appendChild(itemEl);
                }
            }
            processQueue(); // Iniciar el procesamiento de la cola
        }

        async function processQueue() {
            if (isUploading || uploadQueue.length === 0) {
                return; // Si ya hay algo subiendo, o no hay nada en la cola, esperar.
            }
            
            isUploading = true;
            const job = uploadQueue.shift(); // Tomar el primer item de la cola
            const itemEl = document.getElementById(job.id);
            const statusEl = itemEl.querySelector('.queue-status');
            
            try {
                statusEl.textContent = 'Subiendo...';
                statusEl.className = 'queue-status status-uploading';

                const formData = new FormData();
                formData.append('audio', job.file);
                // (El t√≠tulo y tipo se quedan por defecto, puedes a√±adir inputs si quieres)

                await axios.post(`${API_BASE}/upload`, formData, {
                    headers: { 'x-api-key': API_KEY, 'Content-Type': 'multipart/form-data' }
                });

                statusEl.textContent = '¬°Completado!';
                statusEl.className = 'queue-status status-done';
            
            } catch (error) {
                statusEl.textContent = 'Error';
                statusEl.className = 'queue-status status-error';
                handleError(`Error subiendo ${job.file.name}`, error, false); // No mostrar alerta, solo log
            }
            
            isUploading = false;
            processQueue(); // Llamar al siguiente en la cola
        }

        // --- ============================================= ---
        // --- PESTA√ëA 2: L√ìGICA DEL GESTOR DE PLAYLIST      ---
        // --- ============================================= ---
        const searchInput = document.getElementById('searchInput');
        const playlistContainer = document.getElementById('playlist-container');
        const paginationContainer = document.getElementById('pagination');
        let sortableInstance = null;

        // Cargar lista (con paginaci√≥n y b√∫squeda)
        async function loadPlaylist(page = 1, query = '') {
            loading.style.display = 'flex';
            try {
                const res = await axios.get(`${API_BASE}/playlist`, {
                    headers: authHeaders,
                    params: { pagina: page, query: query }
                });
                renderPlaylist(res.data);
            } catch (error) {
                handleError("Error cargando la playlist", error);
            }
            loading.style.display = 'none';
        }

        // Renderizar la lista y los botones de paginaci√≥n
        function renderPlaylist(data) {
            playlistContainer.innerHTML = ''; // Limpiar lista
            
            // Renderizar items
            data.items.forEach(item => {
                const div = document.createElement('div');
                div.className = `playlist-item ${item.type}`;
                div.dataset.uuid = item.uuid;
                div.innerHTML = `
                    <input type="checkbox" class="item-checkbox" data-uuid="${item.uuid}">
                    <div class="handle">‚ò∞</div>
                    <div class="info">
                        <strong>${item.title}</strong>
                        <div class="meta">
                            ${item.type.toUpperCase()} | ‚è±Ô∏è ${Math.round(item.duration)}s | üìÖ ${new Date(item.createdAt).toLocaleDateString()}
                        </div>
                    </div>
                    <div class="actions">
                        <a href="${item.audioUrl}" target="_blank" class="btn-small btn-blue" style="text-decoration: none;">‚ñ∂Ô∏è Escuchar</a>
                        <button class="btn-small btn-red" onclick="deleteTrack('${item.uuid}')">üóëÔ∏è Borrar</button>
                    </div>
                `;
                playlistContainer.appendChild(div);
            });

            // Renderizar paginaci√≥n
            paginationContainer.innerHTML = '';
            if (data.totalPages > 1) {
                // Bot√≥n "Anterior"
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '<< Anterior';
                prevBtn.disabled = data.currentPage === 1;
                prevBtn.onclick = () => loadPlaylist(data.currentPage - 1, searchInput.value);
                paginationContainer.appendChild(prevBtn);

                // Texto "P√°gina X de Y"
                const pageInfo = document.createElement('span');
                pageInfo.textContent = `P√°gina ${data.currentPage} de ${data.totalPages}`;
                paginationContainer.appendChild(pageInfo);

                // Bot√≥n "Siguiente"
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Siguiente >>';
                nextBtn.disabled = data.currentPage === data.totalPages;
                nextBtn.onclick = () => loadPlaylist(data.currentPage + 1, searchInput.value);
                paginationContainer.appendChild(nextBtn);
            }
            
            // (Re)iniciar el Drag & Drop
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(playlistContainer, {
                handle: '.handle',
                animation: 150,
                onEnd: onDragEnd
            });
        }
        
        // B√∫squeda (con "debounce" para no hacer 1000 llamadas)
        let searchTimeout;
        searchInput.onkeyup = () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadPlaylist(1, searchInput.value);
            }, 500); // Espera 500ms despu√©s de que el usuario deja de teclear
        };
        
        // Guardar orden al arrastrar
        async function onDragEnd() {
            const newOrderItems = [];
            document.querySelectorAll('#playlist-container .playlist-item').forEach((el, index) => {
                newOrderItems.push({ uuid: el.dataset.uuid, order: index + 1 });
            });

            loading.style.display = 'flex';
            try {
                // NOTA: Esto solo guarda el orden de la p√°gina actual.
                // Para guardar el orden de 300+ canciones, necesitar√≠amos una l√≥gica m√°s compleja
                // Por ahora, solo funciona bien si no est√°s buscando (sort by 'order').
                await axios.post(`${API_BASE}/reorder`, { items: newOrderItems }, { headers: authHeaders });
            } catch (error) {
                handleError("Error guardando el orden", error);
            }
            loading.style.display = 'none';
        }

        // Borrar una sola canci√≥n
        async function deleteTrack(uuid) {
            if (!confirm("¬øSeguro que quieres eliminar este audio?")) return;
            loading.style.display = 'flex';
            try {
                await axios.delete(`${API_BASE}/track/${uuid}`, { headers: authHeaders });
                loadPlaylist(1, searchInput.value); // Recargar
            } catch (error) {
                handleError("Error al eliminar", error);
            }
            loading.style.display = 'none';
        }

        // Borrado M√∫ltiple
        document.getElementById('deleteSelectedBtn').onclick = async () => {
            const selectedUuids = [];
            document.querySelectorAll('.item-checkbox:checked').forEach(el => {
                selectedUuids.push(el.dataset.uuid);
            });

            if (selectedUuids.length === 0) return alert("No has seleccionado ninguna canci√≥n.");
            if (!confirm(`¬øSeguro que quieres eliminar ${selectedUuids.length} canciones?`)) return;

            loading.style.display = 'flex';
            try {
                await axios.delete(`${API_BASE}/tracks`, { 
                    headers: authHeaders,
                    data: { uuids: selectedUuids } // axios 'delete' env√≠a 'data'
                });
                loadPlaylist(1, searchInput.value); // Recargar
            } catch (error) {
                handleError("Error en borrado m√∫ltiple", error);
            }
            loading.style.display = 'none';
        };

        // --- ============================================= ---
        // --- PESTA√ëA 3: L√ìGICA DE PUBLICACI√ìN              ---
        // --- ============================================= ---
        const publishLog = document.getElementById('publish-log');

        function logToPanel(message, isError = false) {
            const time = new Date().toLocaleTimeString();
            const color = isError ? 'var(--red)' : 'var(--green)';
            publishLog.innerHTML = `<div style="color: ${color};">[${time}] ${message}</div>` + publishLog.innerHTML;
        }

        // Bot√≥n "Publicar"
        document.getElementById('publish-btn').onclick = async () => {
            if (!confirm("¬øEst√°s seguro?\nEsto reiniciar√° el stream en vivo (1-2s de silencio) para aplicar todos tus cambios.")) return;
            
            loading.style.display = 'flex';
            try {
                const res = await axios.post(`${API_BASE}/publish`, {}, { headers: authHeaders });
                alert(`‚úÖ ¬°√âxito! ${res.data.message}`);
                logToPanel(res.data.message);
            } catch (error) {
                handleError("Error al Publicar", error);
                logToPanel(error.response?.data?.error || error.message, true);
            }
            loading.style.display = 'none';
        };

        // Bot√≥n "Ver TXT (Borrador)"
        const txtViewer = document.getElementById('txt-viewer');
        document.getElementById('viewTxtBtn').onclick = async () => {
            loading.style.display = 'flex';
            try {
                const res = await axios.get(`${API_BASE}/playlist.txt`, { headers: authHeaders });
                txtViewer.textContent = res.data;
                txtViewer.style.display = 'block';
            } catch (error) {
                handleError("Error al cargar el TXT", error);
            }
            loading.style.display = 'none';
        };

        // --- ============================================= ---
        // --- INICIO Y HELPERS                            ---
        // --- ============================================= ---
        
        // Helper de Errores
        function handleError(message, error, showAlert = true) {
            console.error(message, error);
            const errorMsg = error.response?.data?.error || error.message;
            if (showAlert) alert(`‚ùå ${message}: ${errorMsg}`);
        }

        // Iniciar
        showTab('tab-upload'); // Empezar en la pesta√±a de subida
    </script>
</body>
</html>